#!/bin/sh
# {%@rot13 QB ABG RQVG %}
#
# This shell script prepares the docker container and other scrips needed to execute the intergration tests.
# At the end, it starts the docker container, which will start the script integrationtest.
#
set -e

#
# The code in Github runs from the root directory
#
if [ -d .mvn ]; then
  cd jamal-test/IT_DOCKER
fi

#
# Create the dockerfile
#
cat > Dockerfile <<END
FROM alpine
RUN apk update
RUN apk add --no-cache openjdk17 maven git python3 py3-pip
RUN addgroup TESTGROUP
RUN adduser -G TESTGROUP -D -s /bin/bash jamal

WORKDIR /home/jamal
COPY integrationtest .
RUN chown jamal:TESTGROUP integrationtest
RUN chmod u+xr integrationtest
USER jamal
CMD ./integrationtest
END

#
# Build the docker image
#
docker build -t jamal-test .
rm Dockerfile
if [ $? -ne 0 ]; then
  echo "Docker build failed. Exiting."
  exit 1
fi

#
# Run the integration test
#
START_TIME=$(date +%s)
mv integration_test.log integration_test.log.BAK || echo "no previous log"
docker run -it jamal-test | sed -r "s/\x1B\[[0-9;]*[mK]//g" | tee -a integration_test.log

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))
sleep 1

#
# Delete the progress lines from the log (approx 27k lines to 4k)
#
sed -i -E '/Progress/d; /Receiving objects:/d; /remote: Counting objects:/d; /remote: Compressing objects:/d; /Resolving deltas:/d' integration_test.log

if tail -n1 integration_test.log | grep -q "INTEGRATION TEST SUCCESSFUL"; then
    RESULT=0
else
    RESULT=1
fi

if [ $RESULT -eq 0 ]; then
    echo "OK $(date '+%Y-%m-%d %H:%M:%S')" > integration_test.run
    echo "INTEGRATION TEST OK $DURATION sec"
    exit 0
else
    echo "FAIL $(date '+%Y-%m-%d %H:%M:%S')" > integration_test.run
    echo "FAIL $DURATION sec"
    exit 1
fi